<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa GTA GPS</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }
    .bar{
      position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 10; width: min(720px, 92vw);
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,0.94);
      border-radius: 12px; padding: 10px 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      backdrop-filter: blur(6px);
    }
    .bar button{
      border: 0; background: #111; color: #fff; padding: 10px 12px; border-radius: 10px;
      cursor: pointer; font-weight: 600;
    }
    .bar button.secondary{ background:#e9e9e9; color:#111; }
    .bar .status{ flex: 1; font-size: 14px; color:#222; }
    .toast{
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      background: rgba(17,17,17,0.92); color:#fff; padding: 10px 14px; border-radius: 999px;
      z-index: 10; font-size: 13px; display:none;
    }
  </style>
</head>
<body>
  <div class="bar">
    <div class="status" id="status">Cargando mapa…</div>
    <button class="secondary" id="btnFollow">Seguir</button>
    <button id="btnStop">Stop</button>
  </div>
  <div class="toast" id="toast"></div>
  <div id="map"></div>

  <script>
    let map;
    let userMarker;
    let destMarker;
    let routeLine;
    let routeOutline;
    let watchId = null;
    let navigating = false;
    let currentDestination = null;
    let routeRequestInFlight = false;
    let lastUserLatLng = null;

    const DEFAULT_CENTER = { lat: 40.4168, lng: -3.7038 };

    const OFF_ROUTE_METERS = 45;
    const OFF_ROUTE_MIN_SECONDS = 10;
    let lastOffRouteCheckMs = 0;
    let offRouteHits = 0;
    const OFF_ROUTE_HITS_REQUIRED = 2; // nº de checks seguidos fuera de ruta para recalcular

    const NAV_ZOOM = 17;
    let followMe = true;

    const LONG_PRESS_MS = 500;
    let pressTimer = null;
    let pressLatLng = null;

    function toast(msg, ms=1400){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display="none", ms);
    }

    function setEstado(txt){
      document.getElementById("status").textContent = txt;
    }

    function clearRoute(){
      if (routeLine) routeLine.setMap(null);
      if (routeOutline) routeOutline.setMap(null);
      routeLine = null;
      routeOutline = null;
    }

    function setDestination(latLng){
      currentDestination = latLng;
      if (!destMarker){
        destMarker = new google.maps.Marker({
          position: latLng,
          map,
          title: "Destino",
          icon: {
            path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
            scale: 6,
            fillColor: "#ff3b30",
            fillOpacity: 1,
            strokeColor: "#ffffff",
            strokeWeight: 2
          }
        });
      } else {
        destMarker.setPosition(latLng);
      }
      toast("Destino marcado");
      if (lastUserLatLng) {
        calcularRuta(false);
      } else {
        setEstado("Destino listo. Esperando GPS…");
      }
    }

    async function calcularRuta(isRecalc){
      if (!lastUserLatLng || !currentDestination) return;
      if (routeRequestInFlight) return;
      routeRequestInFlight = true;

      setEstado(isRecalc ? "Recalculando ruta…" : "Calculando ruta…");

      try{
        const dirService = new google.maps.DirectionsService();
        const res = await dirService.route({
          origin: lastUserLatLng,
          destination: currentDestination,
          travelMode: google.maps.TravelMode.DRIVING
        });

        const route = res.routes?.[0];
        if (!route) throw new Error("Sin ruta");

        const path = route.overview_path;

        clearRoute();

        routeOutline = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#800E82",
          strokeOpacity: 0.25,
          strokeWeight: 12,
          zIndex: 1
        });

        routeLine = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#800E82",
          strokeOpacity: 1,
          strokeWeight: 7,
          zIndex: 2
        });

        navigating = true;
        setEstado("Navegando…");
        if (followMe) map.panTo(lastUserLatLng);
      } catch(e){
        console.error(e);
        setEstado("Error calculando ruta");
        toast("No pude calcular la ruta");
      } finally {
        routeRequestInFlight = false;
      }
    }

    // --- PUNTO 2 + 3 (tolerancia mejorada + antirrebote) ---
    function metersToDegreesLat(m) { return m / 111320; }
    function metersToDegreesLng(m, latDeg) {
      return m / (111320 * Math.cos(latDeg * Math.PI / 180));
    }

    function isOffRoute(userLatLng) {
      if (!routeLine || !google.maps.geometry?.poly) return false;

      const lat = userLatLng.lat();
      // Convertimos metros a grados (lat y lon) y usamos el más conservador como tolerancia.
      const tolDeg = Math.max(
        metersToDegreesLat(OFF_ROUTE_METERS),
        metersToDegreesLng(OFF_ROUTE_METERS, lat)
      );

      const onEdge = google.maps.geometry.poly.isLocationOnEdge(userLatLng, routeLine, tolDeg);
      return !onEdge;
    }

    function handleOffRouteCheck(userLatLng) {
      if (!isOffRoute(userLatLng)) { offRouteHits = 0; return; }
      offRouteHits++;
      if (offRouteHits >= OFF_ROUTE_HITS_REQUIRED) {
        offRouteHits = 0;
        calcularRuta(true);
      }
    }
    // --- FIN PUNTO 2 + 3 ---

    function startWatch(){
      if (!navigator.geolocation) { alert("Geolocalización no disponible"); return; }
      if (watchId !== null) return;

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const latLng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          const heading = pos.coords.heading;
          lastUserLatLng = latLng;

          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: latLng,
              map,
              title: "Tú",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillColor: "#ffffff",
                fillOpacity: 1,
                strokeColor: "#000000",
                strokeWeight: 3
              }
            });
            map.setCenter(latLng);
            map.setZoom(NAV_ZOOM);
          } else {
            userMarker.setPosition(latLng);

            if (navigating && followMe) {
              map.panTo(latLng);
              if (map.getZoom() !== NAV_ZOOM) map.setZoom(NAV_ZOOM);
            }
            if (heading !== null && !isNaN(heading)) {
              map.setHeading(heading);
            }
          }

          setEstado(navigating ? "Navegando…" : "Ubicación OK");

          // Recalcular SOLO si te sales de la ruta (con antirrebote)
          if (navigating && currentDestination && routeLine && !routeRequestInFlight) {
            const now = Date.now();
            const secondsSince = (now - lastOffRouteCheckMs) / 1000;

            if (secondsSince >= OFF_ROUTE_MIN_SECONDS) {
              lastOffRouteCheckMs = now;
              handleOffRouteCheck(latLng);
            }
          }
        },
        (err) => {
          console.error(err);
          setEstado("Activa ubicación (GPS)");
          alert("Necesito permiso de ubicación.");
        },
        {
          enableHighAccuracy: true,
          maximumAge: 800,
          timeout: 12000
        }
      );
    }

    function stopNav(){
      navigating = false;
      currentDestination = null;
      offRouteHits = 0;
      clearRoute();
      if (destMarker) { destMarker.setMap(null); destMarker = null; }
      setEstado("Parado");
      toast("Navegación detenida");
    }

    function setupLongPress(){
      map.addListener("mousedown", (e) => {
        pressLatLng = e.latLng;
        pressTimer = setTimeout(() => {
          if (pressLatLng) setDestination(pressLatLng);
        }, LONG_PRESS_MS);
      });
      map.addListener("mouseup", () => {
        if (pressTimer) clearTimeout(pressTimer);
        pressTimer = null;
        pressLatLng = null;
      });
      map.addListener("drag", () => {
        if (pressTimer) clearTimeout(pressTimer);
        pressTimer = null;
      });

      // Touch
      map.addListener("touchstart", (e) => {
        pressLatLng = e.latLng;
        pressTimer = setTimeout(() => {
          if (pressLatLng) setDestination(pressLatLng);
        }, LONG_PRESS_MS);
      });
      map.addListener("touchend", () => {
        if (pressTimer) clearTimeout(pressTimer);
        pressTimer = null;
        pressLatLng = null;
      });
    }

    function initUI(){
      document.getElementById("btnFollow").addEventListener("click", () => {
        followMe = !followMe;
        document.getElementById("btnFollow").textContent = followMe ? "Seguir" : "Libre";
        toast(followMe ? "Cámara siguiendo" : "Cámara libre");
      });
      document.getElementById("btnStop").addEventListener("click", stopNav);

      // Si el usuario arrastra el mapa, desactivamos follow
      map.addListener("dragstart", () => {
        followMe = false;
        document.getElementById("btnFollow").textContent = "Libre";
      });
    }

    async function initMap(){
      setEstado("Cargando mapa…");
      map = new google.maps.Map(document.getElementById("map"), {
        center: DEFAULT_CENTER,
        zoom: 14,
        mapId: "YOUR_MAP_ID_HERE",
        disableDefaultUI: true,
        heading: 0,
        tilt: 45
      });

      setupLongPress();
      initUI();
      startWatch();
      setEstado("Mantén pulsado para marcar destino");
    }

    window.initMap = initMap;
  </script>
  <!-- IMPORTANTE: libraries=places para Autocomplete -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpS3k1OJAASoGL1IRb9LjKW6gjaHe5fyw&callback=initMap&v=weekly&libraries=places,geometry"
  defer
></script>

</body>
</html>



































