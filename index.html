<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa GTA GPS</title>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }

    .bar{
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: min(720px, 92vw);
      display: flex;
      gap: 8px;
      background: rgba(255,255,255,0.94);
      padding: 10px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      align-items: center;
    }
    .bar input{
      flex: 1;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #cfcfcf;
      outline: none;
    }
    .bar button{
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: #111;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .bar button:hover{ opacity: .88; }

    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      color: #111;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="bar">
    <input id="destino" type="text" placeholder="Destino (ej: Plaza Espa√±a, Madrid)" />
    <button id="btnIr" type="button">Ir</button>
    <button id="btnCentrar" type="button">Centrar</button>
    <span class="chip" id="estado">Listo</span>
  </div>

  <div id="map"></div>

  <script>
    // ==== CONFIG ====
    const MAP_ID = "818f2355ad2d42eff8904298";
    const DEFAULT_CENTER = { lat: 40.4168, lng: -3.7038 }; // Madrid

    // Recalcular ruta si:
    const REROUTE_MIN_SECONDS = 12;   // m√≠nimo tiempo entre rec√°lculos
    const REROUTE_MIN_METERS  = 80;   // m√≠nimo desplazamiento para recalcular

    // ==== STATE ====
    let map;
    let directionsService;

    let userMarker = null;
    let watchId = null;
    let lastUserLatLng = null;

    // Ruta estilo GTA (borde negro + l√≠nea blanca)
    let routeOutline = null;
    let routeLine = null;

    // Places autocomplete
    let autocomplete = null;
    let selectedPlaceLatLng = null;

    // Navegaci√≥n / reroute
    let navigating = false;
    let currentDestination = null; // puede ser LatLng o string
    let lastRouteOriginLatLng = null;
    let lastRouteTimeMs = 0;
    let routeRequestInFlight = false;

    function setEstado(txt) {
      const el = document.getElementById("estado");
      if (el) el.textContent = txt;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: DEFAULT_CENTER,
        zoom: 13,
        mapId: MAP_ID,
        fullscreenControl: false,
        mapTypeControl: false,
        streetViewControl: false
      });

      directionsService = new google.maps.DirectionsService();

      // Autocomplete (Places)
      const input = document.getElementById("destino");
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["geometry", "name", "formatted_address"]
        // componentRestrictions: { country: "es" }
      });
if (!google.maps.places) {
  setEstado("Places no carg√≥ (sigue funcionando sin sugerencias)");
  return; // sin autocompletar, pero el resto sigue
}
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (place?.geometry?.location) {
          selectedPlaceLatLng = place.geometry.location;
          setEstado("Destino listo ‚úÖ");
        } else {
          selectedPlaceLatLng = null;
          setEstado("Elige un destino de la lista");
        }
      });

      document.getElementById("btnIr").addEventListener("click", () => calcularRuta(false));
      document.getElementById("btnCentrar").addEventListener("click", () => {
        if (lastUserLatLng) {
          map.panTo(lastUserLatLng);
          map.setZoom(16);
        } else {
          setEstado("Sin ubicaci√≥n todav√≠a");
        }
      });

      iniciarSeguimiento();
      setEstado("Mapa cargado ‚úÖ");
    }
    window.initMap = initMap;

    function iniciarSeguimiento() {
      if (!navigator.geolocation) {
        setEstado("Geolocalizaci√≥n no disponible");
        return;
      }
      if (watchId !== null) return;

      setEstado("Pidiendo ubicaci√≥n‚Ä¶");

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const latLng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          lastUserLatLng = latLng;

          // Marcador usuario
          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: latLng,
              map,
              title: "T√∫",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillColor: "#ffffff",
                fillOpacity: 1,
                strokeColor: "#000000",
                strokeWeight: 3
              }
            });
            map.setCenter(latLng);
            map.setZoom(15);
          } else {
            userMarker.setPosition(latLng);
          }

          setEstado(navigating ? "Navegando‚Ä¶" : "Ubicaci√≥n OK");

          // ==== REC√ÅLCULO AUTOM√ÅTICO ====
          if (navigating && currentDestination && lastRouteOriginLatLng) {
            const moved = distanceMeters(lastUserLatLng, lastRouteOriginLatLng);
            const secondsSince = (Date.now() - lastRouteTimeMs) / 1000;

            if (!routeRequestInFlight &&
                moved >= REROUTE_MIN_METERS &&
                secondsSince >= REROUTE_MIN_SECONDS) {
              // Recalcula sin alerts (silencioso)
              calcularRuta(true);
            }
          }
        },
        (err) => {
          console.error(err);
          setEstado("Activa ubicaci√≥n (GPS)");
          alert("Necesito permiso de ubicaci√≥n para seguirte en tiempo real.");
        },
        { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
      );
    }

    function limpiarRuta() {
      if (routeOutline) routeOutline.setMap(null);
      if (routeLine) routeLine.setMap(null);
      routeOutline = null;
      routeLine = null;
    }

    // Distancia (Haversine) sin librer√≠as extra
    function distanceMeters(a, b) {
      const R = 6371000;
      const lat1 = a.lat() * Math.PI / 180;
      const lat2 = b.lat() * Math.PI / 180;
      const dLat = lat2 - lat1;
      const dLng = (b.lng() - a.lng()) * Math.PI / 180;

      const s1 = Math.sin(dLat / 2);
      const s2 = Math.sin(dLng / 2);
      const h = s1*s1 + Math.cos(lat1) * Math.cos(lat2) * s2*s2;
      return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));
    }

    async function calcularRuta(silencioso) {
      if (!lastUserLatLng) {
        setEstado("Esperando tu ubicaci√≥n‚Ä¶");
        if (!silencioso) alert("A√∫n no tengo tu ubicaci√≥n. Acepta permisos de GPS y espera 1-2 segundos.");
        return;
      }

      const destinoInput = document.getElementById("destino").value.trim();
      if (!destinoInput && !selectedPlaceLatLng) {
        setEstado("Escribe un destino");
        if (!silencioso) alert("Escribe un destino primero üôÇ");
        return;
      }

      // Definimos destino actual (se mantiene para reroute)
      currentDestination = selectedPlaceLatLng ? selectedPlaceLatLng : destinoInput;
      navigating = true;

      // Evitar peticiones simult√°neas
      if (routeRequestInFlight) return;
      routeRequestInFlight = true;

      setEstado(silencioso ? "Recalculando‚Ä¶" : "Calculando ruta‚Ä¶");

      try {
        const res = await directionsService.route({
          origin: lastUserLatLng,
          destination: currentDestination,
          travelMode: google.maps.TravelMode.DRIVING
        });

        const path = res.routes?.[0]?.overview_path;
        if (!path || path.length === 0) {
          setEstado("Sin ruta");
          if (!silencioso) alert("No encontr√© una ruta. Prueba con otro destino.");
          navigating = false;
          routeRequestInFlight = false;
          return;
        }

        // Guardamos ‚Äúpunto de referencia‚Äù para saber cu√°nto te has movido
        lastRouteOriginLatLng = lastUserLatLng;
        lastRouteTimeMs = Date.now();

        // Redibujamos ruta estilo GTA
        limpiarRuta();

        routeOutline = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#800E82",
          strokeOpacity: 1,
          strokeWeight: 10,
          zIndex: 1
        });

        routeLine = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#D31ED6",
          strokeOpacity: 1,
          strokeWeight: 6,
          zIndex: 2
        });

        // Ajuste de c√°mara solo cuando NO es silencioso (para que no maree mientras conduces)
        if (!silencioso) {
          const bounds = new google.maps.LatLngBounds();
          path.forEach(p => bounds.extend(p));
          map.fitBounds(bounds);
        }

        setEstado("Ruta lista üõ£Ô∏è");
      } catch (err) {
        console.error(err);
        setEstado("Error ruta");
        if (!silencioso) alert("No pude calcular la ruta. Prueba eligiendo un destino de la lista.");
      } finally {
        routeRequestInFlight = false;
      }
    }
  </script>

  <!-- IMPORTANTE: libraries=places para Autocomplete -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpS3k1OJAASoGL1IRb9LjKW6gjaHe5fyw&callback=initMap&v=weekly&libraries=places"
  defer
></script>

</body>
</html>











