<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa GTA GPS</title>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }

    .bar{
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: min(720px, 92vw);
      display: flex;
      gap: 8px;
      background: rgba(255,255,255,0.94);
      padding: 10px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      align-items: center;
    }
    .bar input{
      flex: 1;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #cfcfcf;
      outline: none;
    }
    .bar button{
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: #111;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .bar button:hover{ opacity: .88; }

    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      color: #111;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="bar">
    <input id="destino" type="text" placeholder="Destino (ej: Plaza Espa√±a, Madrid)" />
    <button id="btnIr" type="button">Ir</button>
    <button id="btnCentrar" type="button">Centrar</button>
    <span class="chip" id="estado">Listo</span>
  </div>

  <div id="map"></div>

  <script>
    // ==== CONFIG ====
    const MAP_ID = "818f2355ad2d42eff8904298";
    const DEFAULT_CENTER = { lat: 40.4168, lng: -3.7038 }; // Madrid

    // ==== STATE ====
    let map;
    let directionsService;

    let userMarker = null;
    let watchId = null;
    let lastUserLatLng = null;

    // Ruta estilo GTA (borde negro + l√≠nea blanca)
    let routeOutline = null;
    let routeLine = null;

    // Places autocomplete
    let autocomplete = null;
    let selectedPlaceLatLng = null;

    function setEstado(txt) {
      const el = document.getElementById("estado");
      if (el) el.textContent = txt;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: DEFAULT_CENTER,
        zoom: 13,
        mapId: MAP_ID,
        fullscreenControl: false,
        mapTypeControl: false,
        streetViewControl: false
      });

      directionsService = new google.maps.DirectionsService();

      // Autocomplete (Places)
      const input = document.getElementById("destino");
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["geometry", "name", "formatted_address"],
        // componentRestrictions: { country: "es" } // si quieres limitar a Espa√±a
      });
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (place?.geometry?.location) {
          selectedPlaceLatLng = place.geometry.location;
          setEstado("Destino listo ‚úÖ");
        } else {
          selectedPlaceLatLng = null;
          setEstado("Elige un destino de la lista");
        }
      });

      // Botones
      document.getElementById("btnIr").addEventListener("click", calcularRuta);
      document.getElementById("btnCentrar").addEventListener("click", () => {
        if (lastUserLatLng) {
          map.panTo(lastUserLatLng);
          map.setZoom(16);
        } else {
          setEstado("Sin ubicaci√≥n todav√≠a");
        }
      });

      // Empezar a seguir tu ubicaci√≥n en tiempo real
      iniciarSeguimiento();

      setEstado("Mapa cargado ‚úÖ");
    }
    window.initMap = initMap;

    function iniciarSeguimiento() {
      if (!navigator.geolocation) {
        setEstado("Geolocalizaci√≥n no disponible");
        return;
      }

      // Si ya hay un watch, no lo dupliques
      if (watchId !== null) return;

      setEstado("Pidiendo ubicaci√≥n‚Ä¶");

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const latLng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          lastUserLatLng = latLng;

          // Crear o mover marcador del usuario
          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: latLng,
              map,
              title: "T√∫",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillColor: "#ffffff",
                fillOpacity: 1,
                strokeColor: "#000000",
                strokeWeight: 3
              }
            });
            map.setCenter(latLng);
            map.setZoom(15);
          } else {
            userMarker.setPosition(latLng);
          }

          // Si est√°s navegando (hay ruta), podemos recalcular si te alejas mucho (opcional)
          // Para no gastar de m√°s, lo dejamos manual por ahora.

          setEstado("Ubicaci√≥n OK");
        },
        (err) => {
          console.error(err);
          setEstado("Activa ubicaci√≥n (GPS)");
          alert("Necesito permiso de ubicaci√≥n para seguirte en tiempo real.");
        },
        { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
      );
    }

    function limpiarRuta() {
      if (routeOutline) routeOutline.setMap(null);
      if (routeLine) routeLine.setMap(null);
      routeOutline = null;
      routeLine = null;
    }

    async function calcularRuta() {
      // Origen: tu ubicaci√≥n actual
      if (!lastUserLatLng) {
        setEstado("Esperando tu ubicaci√≥n‚Ä¶");
        alert("A√∫n no tengo tu ubicaci√≥n. Acepta permisos de GPS y espera 1-2 segundos.");
        return;
      }

      // Destino: si elegiste de la lista, usamos coordenadas. Si no, usamos texto.
      const destinoInput = document.getElementById("destino").value.trim();
      if (!destinoInput) {
        setEstado("Escribe un destino");
        alert("Escribe un destino primero üôÇ");
        return;
      }

      const destination = selectedPlaceLatLng ? selectedPlaceLatLng : destinoInput;

      setEstado("Calculando ruta‚Ä¶");
      limpiarRuta();

      try {
        const res = await directionsService.route({
          origin: lastUserLatLng,
          destination,
          travelMode: google.maps.TravelMode.DRIVING
        });

        // Dibujar nuestra polil√≠nea estilo GTA
        const path = res.routes?.[0]?.overview_path;
        if (!path || path.length === 0) {
          setEstado("Sin ruta");
          alert("No encontr√© una ruta. Prueba con otro destino.");
          return;
        }

        // Borde negro (m√°s ancho)
        routeOutline = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#000000",
          strokeOpacity: 1,
          strokeWeight: 10,
          zIndex: 1
        });

        // L√≠nea blanca encima (m√°s fina)
        routeLine = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#ffffff",
          strokeOpacity: 1,
          strokeWeight: 6,
          zIndex: 2
        });

        // Ajustar c√°mara a la ruta
        const bounds = new google.maps.LatLngBounds();
        path.forEach(p => bounds.extend(p));
        map.fitBounds(bounds);

        setEstado("Ruta lista üõ£Ô∏è");
      } catch (err) {
        console.error(err);
        setEstado("Error ruta");
        alert("No pude calcular la ruta. Prueba eligiendo un destino de la lista.");
      }
    }
  </script>

  <!-- IMPORTANTE: libraries=places para Autocomplete -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_AQUI&callback=initMap&v=weekly&libraries=places"
    defer
  ></script>
</body>
</html>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpS3k1OJAASoGL1IRb9LjKW6gjaHe5fyw&callback=initMap&v=weekly"
  defer>
</script>

</body>
</html>



