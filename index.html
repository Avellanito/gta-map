<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa GTA GPS</title>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }

    .bar{
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: min(720px, 92vw);
      display: flex;
      gap: 8px;
      background: rgba(255,255,255,0.94);
      padding: 10px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      align-items: center;
    }
    .bar input{
      flex: 1;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #cfcfcf;
      outline: none;
    }
    .bar button{
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: #111;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .bar button:hover{ opacity: .88; }

    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      color: #111;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="bar">
    <input id="destino" type="text" placeholder="Destino (ej: Plaza Espa√±a, Madrid)" />
    <button id="btnIr" type="button">Ir</button>
    <button id="btnCentrar" type="button">Centrar</button>
    <span class="chip" id="estado">Listo</span>
  </div>

  <div id="map"></div>

  <script>
    // ==== CONFIG ====
    const MAP_ID = "818f2355ad2d42eff8904298";
    const DEFAULT_CENTER = { lat: 40.4168, lng: -3.7038 }; // Madrid

    // Recalcular ruta si:
    const REROUTE_MIN_SECONDS = 12;   // m√≠nimo tiempo entre rec√°lculos
    const REROUTE_MIN_METERS  = 80;   // m√≠nimo desplazamiento para recalcular
    const OFF_ROUTE_METERS = 45;   // tolerancia: 45 m (GPS en coche suele ir bien)
    const OFF_ROUTE_MIN_SECONDS = 10; // para no recalcular por ruido del GPS
    let lastOffRouteCheckMs = 0;

    // ==== STATE ====
    let map;
    let directionsService;

    let userMarker = null;
    let watchId = null;
    let lastUserLatLng = null;

    // Ruta estilo GTA (borde negro + l√≠nea blanca)
    let routeOutline = null;
    let routeLine = null;

    // Places autocomplete
    let autocomplete = null;
    let selectedPlaceLatLng = null;

    // Navegaci√≥n / reroute
    let navigating = false;
    let currentDestination = null; // puede ser LatLng o string
    let lastRouteOriginLatLng = null;
    let lastRouteTimeMs = 0;
    let routeRequestInFlight = false;
    let followMe = true;        // seguir al usuario
    const NAV_ZOOM = 16;        // zoom mientras navegas (aj√∫stalo a tu gusto)

    // --- Long press to pin ---
    const LONG_PRESS_MS = 600;     // 600ms = pulsaci√≥n larga
    let longPressTimer = null;
    let pinMarker = null;
    let overlay = null;

    function setEstado(txt) {
      const el = document.getElementById("estado");
      if (el) el.textContent = txt;
    }

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    heading: 0,
    tilt: 45,
    center: DEFAULT_CENTER,
    zoom: 13,
    mapId: MAP_ID,
    fullscreenControl: false,
    mapTypeControl: false,
    streetViewControl: false,
  });

  // Overlay para convertir pantalla -> LatLng (m√≥vil)
  overlay = new google.maps.OverlayView();
  overlay.onAdd = function(){};
  overlay.draw = function(){};
  overlay.setMap(map);

  // ---- Long press con rat√≥n (PC) ----
  map.addListener("mousedown", (e) => startLongPress(e.latLng));
  map.addListener("mouseup", cancelLongPress);
  map.addListener("drag", cancelLongPress);
  map.addListener("mouseout", cancelLongPress);

  // Click derecho = pin r√°pido (PC)
  map.addListener("rightclick", (e) => handlePinnedPoint(e.latLng));

  // ---- Long press con dedo (m√≥vil) ----
  const mapDiv = map.getDiv();
  mapDiv.addEventListener("touchstart", onTouchStart, { passive: true });
  mapDiv.addEventListener("touchend", cancelLongPress, { passive: true });
  mapDiv.addEventListener("touchmove", cancelLongPress, { passive: true });

  // (si tienes aqu√≠ directionsService / autocomplete / listeners de botones, d√©jalos como estaban)
}
window.initMap = initMap;

      directionsService = new google.maps.DirectionsService();

      // Autocomplete (Places)
      const input = document.getElementById("destino");
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["geometry", "name", "formatted_address"]
        // componentRestrictions: { country: "es" }
      });
if (!google.maps.places) {
  setEstado("Places no carg√≥ (sigue funcionando sin sugerencias)");
  return; // sin autocompletar, pero el resto sigue
}
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (place?.geometry?.location) {
          selectedPlaceLatLng = place.geometry.location;
          setEstado("Destino listo ‚úÖ");
        } else {
          selectedPlaceLatLng = null;
          setEstado("Elige un destino de la lista");
        }
      });

      document.getElementById("btnIr").addEventListener("click", () => calcularRuta(false));
      document.getElementById("btnCentrar").addEventListener("click", () => {
        if (lastUserLatLng) {
          map.panTo(lastUserLatLng);
          map.setZoom(16);
        } else {
          setEstado("Sin ubicaci√≥n todav√≠a");
        }
      });

      iniciarSeguimiento();
      setEstado("Mapa cargado ‚úÖ");
    }
    window.initMap = initMap;

    function iniciarSeguimiento() {
      if (!navigator.geolocation) {
        setEstado("Geolocalizaci√≥n no disponible");
        return;
      }
      if (watchId !== null) return;

      setEstado("Pidiendo ubicaci√≥n‚Ä¶");

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const latLng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          const heading = pos.coords.heading;
          lastUserLatLng = latLng;

          // Marcador usuario
          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: latLng,
              map,
              title: "T√∫",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillColor: "#ffffff",
                fillOpacity: 1,
                strokeColor: "#000000",
                strokeWeight: 3
              }
            });
            map.setCenter(latLng);
            map.setZoom(15);
          } else {
            userMarker.setPosition(latLng);
            if (navigating && followMe) {
              map.panTo(latLng);
              if (map.getZoom() < NAV_ZOOM) map.setZoom(NAV_ZOOM);
            } 
            if (heading !== null && !isNaN(heading)) {
              map.setHeading(heading);
            }
          }

          setEstado(navigating ? "Navegando‚Ä¶" : "Ubicaci√≥n OK");

       // ==== REC√ÅLCULO SOLO SI TE SALES DE LA RUTA ====
          if (navigating && currentDestination && routeLine && !routeRequestInFlight) {
            const now = Date.now();
            const secondsSince = (now - lastOffRouteCheckMs) / 1000;

          if (secondsSince >= OFF_ROUTE_MIN_SECONDS) {
            lastOffRouteCheckMs = now;

          if (isOffRoute(latLng)) {
      // recalcula en modo silencioso (no re-encuadra c√°mara)
          calcularRuta(true);
              }
            }
          }
        },
        (err) => {
          console.error(err);
          setEstado("Activa ubicaci√≥n (GPS)");
          alert("Necesito permiso de ubicaci√≥n para seguirte en tiempo real.");
        },
        { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
      );
    }

    function limpiarRuta() {
      if (routeOutline) routeOutline.setMap(null);
      if (routeLine) routeLine.setMap(null);
      routeOutline = null;
      routeLine = null;
    }

    // Distancia (Haversine) sin librer√≠as extra
    function distanceMeters(a, b) {
      const R = 6371000;
      const lat1 = a.lat() * Math.PI / 180;
      const lat2 = b.lat() * Math.PI / 180;
      const dLat = lat2 - lat1;
      const dLng = (b.lng() - a.lng()) * Math.PI / 180;

      const s1 = Math.sin(dLat / 2);
      const s2 = Math.sin(dLng / 2);
      const h = s1*s1 + Math.cos(lat1) * Math.cos(lat2) * s2*s2;
      return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));
    }


    function startLongPress(latLng) {
  cancelLongPress();
  longPressTimer = setTimeout(() => {
    handlePinnedPoint(latLng);
  }, LONG_PRESS_MS);
}

function cancelLongPress() {
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
}

function touchToLatLng(touch) {
  // Convierte el punto tocado (pixeles) a LatLng usando el projection del overlay
  if (!overlay || !overlay.getProjection) return null;
  const proj = overlay.getProjection();
  if (!proj) return null;

  const rect = map.getDiv().getBoundingClientRect();
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;

  return proj.fromContainerPixelToLatLng(new google.maps.Point(x, y));
}

function handlePinnedPoint(latLng) {
  cancelLongPress();

  // Guardar como destino actual (esto hace que calcularRuta use coordenadas exactas)
  selectedPlaceLatLng = latLng;
  currentDestination = latLng;
  navigating = true;

  // Poner/actualizar marcador
  if (!pinMarker) {
    pinMarker = new google.maps.Marker({
      position: latLng,
      map,
      title: "Destino",
    });
  } else {
    pinMarker.setPosition(latLng);
  }

  // (Opcional) Mostrar coordenadas en el input para que quede claro
  const inp = document.getElementById("destino");
  if (inp) inp.value = `Punto: ${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}`;

  // Calcula ruta hacia el pin
  calcularRuta(false);
}

    function isOffRoute(userLatLng) {
    // Si no hay ruta dibujada, no podemos saber
      if (!routeLine) return false;

      // google.maps.geometry.poly.isLocationOnEdge usa tolerancia en "grados"
      // Aproximaci√≥n: 1 grado ~ 111,320 metros (latitud). Para tolerancias peque√±as vale perfecto.
      const toleranceDegrees = OFF_ROUTE_METERS / 111320;

      // Devuelve TRUE si est√°s "sobre" la l√≠nea (con tolerancia). Nosotros queremos lo contrario.
      const onEdge = google.maps.geometry.poly.isLocationOnEdge(
      userLatLng,
      routeLine,
      toleranceDegrees
      );

      return !onEdge;
    }

    async function calcularRuta(silencioso) {
      if (!lastUserLatLng) {
        setEstado("Esperando tu ubicaci√≥n‚Ä¶");
        if (!silencioso) alert("A√∫n no tengo tu ubicaci√≥n. Acepta permisos de GPS y espera 1-2 segundos.");
        return;
      }

      const destinoInput = document.getElementById("destino").value.trim();
      if (!destinoInput && !selectedPlaceLatLng) {
        setEstado("Escribe un destino");
        if (!silencioso) alert("Escribe un destino primero üôÇ");
        return;
      }

      // Definimos destino actual (se mantiene para reroute)
      currentDestination = selectedPlaceLatLng ? selectedPlaceLatLng : destinoInput;
      navigating = true;

      // Evitar peticiones simult√°neas
      if (routeRequestInFlight) return;
      routeRequestInFlight = true;

      setEstado(silencioso ? "Recalculando‚Ä¶" : "Calculando ruta‚Ä¶");

      try {
        const res = await directionsService.route({
          origin: lastUserLatLng,
          destination: currentDestination,
          travelMode: google.maps.TravelMode.DRIVING
        });

       const route = res.routes?.[0];
if (!route) throw new Error("No route");

const path = [];
route.legs.forEach(leg => {
  leg.steps.forEach(step => {
    step.path.forEach(p => path.push(p));
  });
});
        if (!path || path.length === 0) {
          setEstado("Sin ruta");
          if (!silencioso) alert("No encontr√© una ruta. Prueba con otro destino.");
          navigating = false;
          routeRequestInFlight = false;
          return;
        }

        // Guardamos ‚Äúpunto de referencia‚Äù para saber cu√°nto te has movido
        lastRouteOriginLatLng = lastUserLatLng;
        lastRouteTimeMs = Date.now();

        // Redibujamos ruta estilo GTA
        limpiarRuta();

        routeOutline = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#800E82",
          strokeOpacity: 1,
          strokeWeight: 5,
          zIndex: 1
        });

        routeLine = new google.maps.Polyline({
          path,
          map,
          strokeColor: "#800E82",
          strokeOpacity: 1,
          strokeWeight: 3,
          zIndex: 2
        });

        // Ajuste de c√°mara solo cuando NO es silencioso (para que no maree mientras conduces)
        if (!silencioso) {
          const bounds = new google.maps.LatLngBounds();
          path.forEach(p => bounds.extend(p));
          map.fitBounds(bounds);
        }

        setEstado("Ruta lista üõ£Ô∏è");
      } catch (err) {
        console.error(err);
        setEstado("Error ruta");
        if (!silencioso) alert("No pude calcular la ruta. Prueba eligiendo un destino de la lista.");
      } finally {
        routeRequestInFlight = false;
      }
    }
  </script>

  <!-- IMPORTANTE: libraries=places para Autocomplete -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpS3k1OJAASoGL1IRb9LjKW6gjaHe5fyw&callback=initMap&v=weekly&libraries=places,geometry"
  defer
  defer
></script>

</body>
</html>






















