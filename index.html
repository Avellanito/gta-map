<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa GTA GPS</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }
    .bar{
      position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 10; width: min(720px, 92vw);
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,0.94);
      padding: 10px; border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .bar input{
      flex: 1; padding: 10px 12px; font-size: 16px;
      border-radius: 10px; border: 1px solid #cfcfcf; outline: none;
    }
    .bar button{
      padding: 10px 14px; font-size: 16px; border-radius: 10px;
      border: none; background: #111; color: #fff; cursor: pointer;
      white-space: nowrap;
    }
    .chip{
      font-size: 12px; padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,0.06); color: #111; white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="bar">
    <input id="destino" type="text" placeholder="Destino (ej: Plaza Espa√±a, Madrid)" />
    <button id="btnIr" type="button">Ir</button>
    <button id="btnCentrar" type="button">Centrar</button>
    <span class="chip" id="estado">Listo</span>
  </div>

  <div id="map"></div>

  <script>
    // ==== CONFIG ====
    const MAP_ID = "818f2355ad2d42eff8904298";
    const DEFAULT_CENTER = { lat: 40.4168, lng: -3.7038 };

    const OFF_ROUTE_METERS = 45;
    const OFF_ROUTE_MIN_SECONDS = 10;
    let lastOffRouteCheckMs = 0;

    const NAV_ZOOM = 15;
    let followMe = true;

    const LONG_PRESS_MS = 600;

    // ==== STATE ====
    let map, directionsService, autocomplete;
    let overlay = null;

    let watchId = null;
    let lastUserLatLng = null;
    let userMarker = null;

    let navigating = false;
    let currentDestination = null;
    let selectedPlaceLatLng = null;

    let routeRequestInFlight = false;
    let routeOutline = null;
    let routeLine = null;

    let longPressTimer = null;
    let pinMarker = null;

    function setEstado(txt) {
      const el = document.getElementById("estado");
      if (el) el.textContent = txt;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        heading: 0,
        tilt: 45,
        center: DEFAULT_CENTER,
        zoom: 13,
        mapId: MAP_ID,
        fullscreenControl: false,
        mapTypeControl: false,
        streetViewControl: false
      });

      // Overlay para touch -> LatLng
      overlay = new google.maps.OverlayView();
      overlay.onAdd = function(){};
      overlay.draw = function(){};
      overlay.setMap(map);

      // Long press rat√≥n
      map.addListener("mousedown", (e) => startLongPress(e.latLng));
      map.addListener("mouseup", cancelLongPress);
      map.addListener("drag", cancelLongPress);
      map.addListener("mouseout", cancelLongPress);
      map.addListener("rightclick", (e) => handlePinnedPoint(e.latLng));

      // Long press m√≥vil
      const mapDiv = map.getDiv();
      mapDiv.addEventListener("touchstart", onTouchStart, { passive: true });
      mapDiv.addEventListener("touchend", cancelLongPress, { passive: true });
      mapDiv.addEventListener("touchmove", cancelLongPress, { passive: true });

      directionsService = new google.maps.DirectionsService();

      // Autocomplete (si places carg√≥)
      if (google.maps.places) {
        const input = document.getElementById("destino");
        autocomplete = new google.maps.places.Autocomplete(input, {
          fields: ["geometry", "name", "formatted_address"]
        });

        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (place?.geometry?.location) {
            selectedPlaceLatLng = place.geometry.location;
            setEstado("Destino listo ‚úÖ");
          } else {
            selectedPlaceLatLng = null;
            setEstado("Elige un destino de la lista");
          }
        });
      } else {
        setEstado("Places no carg√≥ (sin sugerencias)");
      }

      document.getElementById("btnIr").addEventListener("click", () => calcularRuta(false));
      document.getElementById("btnCentrar").addEventListener("click", () => {
        if (lastUserLatLng) {
          map.panTo(lastUserLatLng);
          map.setZoom(NAV_ZOOM);
        }
      });

      iniciarSeguimiento();
      setEstado("Mapa cargado ‚úÖ");
    }
    window.initMap = initMap;

    function iniciarSeguimiento() {
      if (!navigator.geolocation) { setEstado("Geolocalizaci√≥n no disponible"); return; }
      if (watchId !== null) return;

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const latLng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          const heading = pos.coords.heading;
          lastUserLatLng = latLng;

          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: latLng,
              map,
              title: "T√∫",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillColor: "#ffffff",
                fillOpacity: 1,
                strokeColor: "#000000",
                strokeWeight: 3
              }
            });
            map.setCenter(latLng);
            map.setZoom(NAV_ZOOM);
          } else {
            userMarker.setPosition(latLng);

            if (navigating && followMe) {
              map.panTo(latLng);
              if (map.getZoom() !== NAV_ZOOM) map.setZoom(NAV_ZOOM);
            }
            if (heading !== null && !isNaN(heading)) {
              map.setHeading(heading);
            }
          }

          setEstado(navigating ? "Navegando‚Ä¶" : "Ubicaci√≥n OK");

          // Recalcular SOLO si te sales de la ruta
          if (navigating && currentDestination && routeLine && !routeRequestInFlight) {
            const now = Date.now();
            const secondsSince = (now - lastOffRouteCheckMs) / 1000;

            if (secondsSince >= OFF_ROUTE_MIN_SECONDS) {
              lastOffRouteCheckMs = now;
              if (isOffRoute(latLng)) calcularRuta(true);
            }
          }
        },
        (err) => {
          console.error(err);
          setEstado("Activa ubicaci√≥n (GPS)");
          alert("Necesito permiso de ubicaci√≥n.");
        },
        { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
      );
    }

    function limpiarRuta() {
      if (routeOutline) routeOutline.setMap(null);
      if (routeLine) routeLine.setMap(null);
      routeOutline = null;
      routeLine = null;
    }

    function distanceMeters(a, b) {
      const R = 6371000;
      const lat1 = a.lat() * Math.PI / 180;
      const lat2 = b.lat() * Math.PI / 180;
      const dLat = lat2 - lat1;
      const dLng = (b.lng() - a.lng()) * Math.PI / 180;
      const s1 = Math.sin(dLat / 2);
      const s2 = Math.sin(dLng / 2);
      const h = s1*s1 + Math.cos(lat1) * Math.cos(lat2) * s2*s2;
      return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));
    }

    function isOffRoute(userLatLng) {
      if (!routeLine || !google.maps.geometry?.poly) return false;
      const toleranceDegrees = OFF_ROUTE_METERS / 111320;
      const onEdge = google.maps.geometry.poly.isLocationOnEdge(userLatLng, routeLine, toleranceDegrees);
      return !onEdge;
    }

    function onTouchStart(ev) {
      if (!ev.touches || ev.touches.length !== 1) return;
      const latLng = touchToLatLng(ev.touches[0]);
      if (latLng) startLongPress(latLng);
    }

    function startLongPress(latLng) {
      cancelLongPress();
      longPressTimer = setTimeout(() => handlePinnedPoint(latLng), LONG_PRESS_MS);
    }

    function cancelLongPress() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }

    function touchToLatLng(touch) {
      if (!overlay) return null;
      const proj = overlay.getProjection && overlay.getProjection();
      if (!proj) return null;

      const rect = map.getDiv().getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;

      return proj.fromContainerPixelToLatLng(new google.maps.Point(x, y));
    }

    function handlePinnedPoint(latLng) {
      cancelLongPress();

      selectedPlaceLatLng = latLng;
      currentDestination = latLng;
      navigating = true;

      if (!pinMarker) {
        pinMarker = new google.maps.Marker({ position: latLng, map, title: "Destino" });
      } else {
        pinMarker.setPosition(latLng);
      }

      const inp = document.getElementById("destino");
      if (inp) inp.value = `Punto: ${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}`;

      calcularRuta(false);
    }

    async function calcularRuta(silencioso) {
      if (!lastUserLatLng) {
        if (!silencioso) alert("A√∫n no tengo tu ubicaci√≥n.");
        return;
      }

      const destinoInput = document.getElementById("destino").value.trim();
      if (!destinoInput && !selectedPlaceLatLng) {
        if (!silencioso) alert("Escribe un destino primero üôÇ");
        return;
      }

      currentDestination = selectedPlaceLatLng ? selectedPlaceLatLng : destinoInput;
      navigating = true;

      if (routeRequestInFlight) return;
      routeRequestInFlight = true;

      try {
        const res = await directionsService.route({
          origin: lastUserLatLng,
          destination: currentDestination,
          travelMode: google.maps.TravelMode.DRIVING
        });

        const route = res.routes?.[0];
        if (!route) throw new Error("No route");

        // Path detallado pegado a carretera
        const path = [];
        route.legs.forEach(leg => leg.steps.forEach(step => step.path.forEach(p => path.push(p))));

        if (!path.length) throw new Error("Empty path");

        limpiarRuta();

        // Borde
        routeOutline = new google.maps.Polyline({
          path, map,
          strokeColor: "#000000",
          strokeOpacity: 1,
          strokeWeight: 9,
          zIndex: 1
        });

        // L√≠nea morada
        routeLine = new google.maps.Polyline({
          path, map,
          strokeColor: "#800E82",
          strokeOpacity: 1,
          strokeWeight: 5,
          zIndex: 2
        });

        if (!silencioso) {
          const bounds = new google.maps.LatLngBounds();
          path.forEach(p => bounds.extend(p));
          map.fitBounds(bounds);
        }

        if (!silencioso) {
          map.setZoom(NAV_ZOOM);
      }

        setEstado("Ruta lista üõ£Ô∏è");
      } catch (err) {
        console.error(err);
        setEstado("Error ruta");
        if (!silencioso) alert("No pude calcular la ruta.");
      } finally {
        routeRequestInFlight = false;
      }
    }
  </script>


  <!-- IMPORTANTE: libraries=places para Autocomplete -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpS3k1OJAASoGL1IRb9LjKW6gjaHe5fyw&callback=initMap&v=weekly&libraries=places,geometry"
  defer
></script>

</body>
</html>


























